<?xml version="1.0" encoding="UTF-8"?>
<project basedir="." default="deploy.on.jboss.7.1" name="Idea">

	<target name="deploy.on.jboss.7.1" depends="make.war" description="Build war and deploy to ${deploy.folder}">
		<delete dir="${deploy.folder}/${project.name}.war" />
		<copy todir="${deploy.folder}"  file="${dist.dir}/${project.name}.war" />
	</target>
	
	<target name="make.war" depends="compile, create.manifest, jar">
		<mkdir dir="${dist.dir}"/>
		<mkdir dir="${build.web.dir}"/>
		<copy todir="${build.web.dir}" >
			<fileset dir="${web.dir}" includes="**" />
		</copy>
		<copy file="${web.dir}/WEB-INF/context/datasources-context.xml" 
			tofile="${build.web.dir}/WEB-INF/context/datasources-context.xml" overwrite="true">
			<filterchain>
				<replacetokens>
					<token key="idea.database.url" value="${idea.database.url}" />
					<token key="idea.database.username" value="${idea.database.username}" />
					<token key="idea.database.password" value="${idea.database.password}" />
				</replacetokens>
			</filterchain>
		</copy>

		<war destfile="${dist.dir}/${project.name}.war" webxml="${build.web.dir}/WEB-INF/web.xml" manifest="${build.dir}/MANIFEST.MF">
			<lib file="${lib.dir}/*.jar"/>
			<lib file="${dist.dir}/${jar.file}"/>
			<fileset dir="${build.web.dir}">
				<exclude name="WEB-INF/web.xml"/>
			</fileset>
		</war>
	</target>
	
	<target name="compile" depends="clean, prepare">
		<mkdir dir="${build.dir}" />
		<mkdir dir="${build.classes.dir}" />
		<javac encoding="utf-8" fork="true" memoryinitialsize="256m" memorymaximumsize="512m" nowarn="on" 
			srcdir="${src.dir}" 
			destdir="${build.classes.dir}" 
			includes="**/*.java"
			debug="true" debuglevel="source,lines,vars" deprecation="off">
			<classpath refid="compile.classpath" />
		</javac>
		<copy todir="${build.classes.dir}" overwrite="true">
			<fileset dir="${src.dir}" excludes="**/*.java"/>
			<fileset dir="${web.dir}" includes="META-INF/**"/>
		</copy>
		<copy file="${web.dir}/META-INF/drools_task_persistence.xml"
	             tofile="${build.classes.dir}/META-INF/drools_task_persistence.xml" overwrite="true">
			<filterchain>
				<replacetokens>
					<token key="connection.url" value="${drools.task.database.url}" />
					<token key="user.name" value="${drools.task.database.username}" />
					<token key="password" value="${drools.task.database.password}" />
				</replacetokens>
			</filterchain>
		</copy>
		<copy file="${web.dir}/META-INF/aklero_persistence.xml"
	             tofile="${build.classes.dir}/META-INF/aklero_persistence.xml" overwrite="true">
			<filterchain>
				<replacetokens>
					<token key="connection.url" value="${aklero.database.url}" />
					<token key="user.name" value="${aklero.database.username}" />
					<token key="password" value="${aklero.database.password}" />
				</replacetokens>
			</filterchain>
		</copy>
		<copy file="${web.dir}/META-INF/idea_persistence.xml"
	             tofile="${build.classes.dir}/META-INF/idea_persistence.xml" overwrite="true">
			<filterchain>
				<replacetokens>
					<token key="connection.url" value="${idea.database.url}" />
					<token key="user.name" value="${idea.database.username}" />
					<token key="password" value="${idea.database.password}" />
				</replacetokens>
			</filterchain>
		</copy>
	</target>
	
		<target name="create.manifest" description="Make the manifest">
		<manifest file="${build.dir}/MANIFEST.MF">
			<attribute name="Ant-Version" value="${ant.version}"/>
			<attribute name="Created-By" value="${java.runtime.version} (${java.vendor})"/>
			<attribute name="Implementation-Title" value="${ant.project.name}"/>
			<attribute name="Implementation-Version" value="${version} ${build.label}"/>
		</manifest>
	</target>
	
	<target name="jar" depends="compile" description="Make jar file so aklero can use it">
		<delete file="${dist.dir}/${jar.file}" />
		<mkdir dir="${dist.dir}" />
		<copy file="${ant.dir}/config_override.properties" 
			tofile="${build.classes.dir}/com/aklero/idea/config/config_override.properties" overwrite="true"/>
		<copy file="${src.dir}/com/aklero/idea/config/config.properties" 
			tofile="${build.classes.dir}/com/aklero/idea/config/config.properties" overwrite="true"/>
		<copy file="${src.dir}/com/aklero/idea/config/life_of_loan_db.properties"
				tofile="${build.classes.dir}/com/aklero/idea/config/life_of_loan_db.properties" overwrite="true">
			<filterchain>
				<replacetokens>
					<token key="mongo.database.host" value="${mongo.database.host}" />
					<token key="mongo.database.port" value="${mongo.database.port}" />
					<token key="mongo.database.dbname" value="${mongo.database.dbname}" />
					<token key="mongo.database.username" value="${mongo.database.username}" />
					<token key="mongo.database.password" value="${mongo.database.password}" />
					<token key="mongo.database.authentication.dbname" value="${mongo.database.authentication.dbname}" />
					<token key="mongo.database.replica.set" value="${mongo.database.replica.set}" />
				</replacetokens>
			</filterchain>
		</copy>

		<jar jarfile="${dist.dir}/${jar.file}" basedir="${build.classes.dir}" 
			includes="**/*.*" />
	</target>
</project>